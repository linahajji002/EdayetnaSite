
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{% block title %}Back Office EDAYETNA{% endblock %}</title>
    <!-- plugins:css -->
    {% block css %}
 

    </style>
       <link href="{{ asset('build/css2/main.css') }}" rel="stylesheet">
      <link href="{{ asset('build/assets/vendors/feather/feather.css') }}" rel="stylesheet">
      <link href="{{ asset('build/assets/vendors/css/vendor.bundle.base.css') }}" rel="stylesheet">
      <link href="{{ asset('build/assets/vendors/css/vendor.bundle.base.css') }}" rel="stylesheet">
      <link href="{{ asset('build/assets/vendors/font-awesome/css/font-awesome.min.css') }}" rel="stylesheet">
      <link href="{{ asset('build/assets/vendors/mdi/css/materialdesignicons.min.css') }}" rel="stylesheet">
      <!-- endinject -->
      <!-- Plugin css for this page -->
      <!-- <link rel="stylesheet" href="assets/vendors/datatables.net-bs4/dataTables.bootstrap4.css"> -->
      <link rel="stylesheet" href="{{ asset('build/assets/vendors/datatables.net-bs5/dataTables.bootstrap5.css') }}">
      <link rel="stylesheet" href="{{ asset('build/assets/vendors/ti-icons/css/themify-icons.css') }}">
      <link rel="stylesheet" type="text/css" href="{{ asset('build/assets/js/select.dataTables.min.css') }}">
      <!-- End plugin css for this page -->
      <!-- inject:css -->
      <link rel="stylesheet" href="{{ asset('build/assets/css/styleranim.css') }}">
     {% endblock %}
    <!-- endinject -->
    <link rel="shortcut icon" href="build/assets/images/favicon.png" />
    <!-- Toastr CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Bootstrap JS (for dismissable alerts) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>

/* Forcer l'opacité de la notification */
.toast {
    opacity: 1 !important; /* Pleine visibilité */
}

/* Changer la couleur du fond des alertes selon le type */
.toast-warning {
    background-color:rgb(142, 168, 212) !important; /* Jaune pour warning */
    color: #000 !important; /* Texte en noir pour contraste */
}

.toast-error {
    background-color: #dc3545 !important; /* Rouge pour erreur */
    color: #fff !important;
}

.toast-success {
    background-color: #28a745 !important; /* Vert pour succès */
    color: #fff !important;
}

.toast-info {
    background-color: #17a2b8 !important; /* Bleu pour information */
    color: #fff !important;
}


</style>
  </head>
  <body>{% block body %}
    <div class="container-scroller">
      
      <!-- partial:partials/_navbar.html -->
      <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
  <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
    <a class="navbar-brand brand-logo me-5" href="index.html"><img src="{{ asset('build/assets/images/logo 2.svg') }}" class="me-2" alt="logo" /></a>
  </div>
  <div class="navbar-menu-wrapper d-flex align-items-center justify-content-end">
    <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
      <span class="icon-menu"></span>
    </button>
 
    <ul class="navbar-nav navbar-nav-right">
      
      <li class="nav-item nav-profile dropdown">
        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" id="profileDropdown">
          {% if app.user.photo %}
                                <img src="{{ asset('build/assets/images/' ~ app.user.photo) }}" 
                                    
                                    width="50" height="50" 
                                    style="border-radius: 50%; object-fit: cover;">
                      
                            {% else %}
                                <img src="{{ asset('build/assets/images/userbb.jpeg') }}" 
                                    
                                    width="50" height="50" 
                                    style="border-radius: 50%; object-fit: cover;">
                            {% endif %}  <span class="username">{{ app.user.prenom }}.{{ app.user.nom }}</span>
        </a>
        <div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="profileDropdown">
          <a href="{{ path('profil_user_back', { 'id': app.user.id }) }}" class="dropdown-item" >
            <i class="ti-settings text-primary"></i> Profil </a>
          <a class="dropdown-item" href="{{ path('app_logout') }}">
            <i class="ti-power-off text-primary"></i> Déconnexion </a>
        </div>
      </li>
      
    </ul>
    <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
      <span class="icon-menu"></span>
    </button>
  </div>
</nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <!-- partial:partials/_sidebar.html -->
         <nav class="sidebar sidebar-offcanvas" id="sidebar">
  <ul class="nav">
     <li class="nav-item">
      <a class="nav-link" href="{{ path('app_admin') }}">
        <i class="icon-grid menu-icon"></i>
        <span class="menu-title">Dashboard</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="collapse" href="#ui-basic" aria-expanded="false" aria-controls="ui-basic">
        <i class="mdi mdi-account-multiple"></i>
        <span class="menu-title">Utilisateurs</span>
        <i class="menu-arrow"></i>
      </a>
      <div class="collapse" id="ui-basic">
        <ul class="nav flex-column sub-menu">
          <li class="nav-item"> <a class="nav-link" href="{{ path('app_users') }}">Table</a></li>
        </ul>
      </div>
    </li>
    
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="collapse" href="#form-elements" aria-expanded="false" aria-controls="ui-basic">
        <i class="mdi mdi-cube"></i>
        <span class="menu-title">Produits</span>
        <i class="menu-arrow"></i>
      </a>
      <div class="collapse" id="form-elements">
        <ul class="nav flex-column sub-menu">
          <li class="nav-item"> <a class="nav-link" href="{{ path('app_produit_indexback') }}">Table</a></li>
            <li class="nav-item"> <a class="nav-link" href="{{ path('app_promotion_index') }}">Promotion</a></li>
          
        </ul>
      </div>
    </li>
   
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="collapse" href="#charts" aria-expanded="false" aria-controls="charts">
        <i class="mdi mdi-bowl"></i>
        <span class="menu-title">Ateliers en ligne</span>
        <i class="menu-arrow"></i>
      </a>
      <div class="collapse" id="charts">
        <ul class="nav flex-column sub-menu">
          <li class="nav-item"> <a class="nav-link" href="{{ path('app_atelierenligneadmin') }}">Table</a></li>
        </ul>
      </div>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="collapse" href="#tables" aria-expanded="false" aria-controls="tables">
        <i class="mdi mdi-screwdriver"></i>
        <span class="menu-title">Matériaux</span>
        <i class="menu-arrow"></i>
      </a>
      <div class="collapse" id="tables">
        <ul class="nav flex-column sub-menu">
          <li class="nav-item"> <a class="nav-link" href="{{ path('app_materiaux_index') }}">Table Materiaux</a></li>
          <li class="nav-item"> <a class="nav-link" href="{{ path('app_fournisseur_index') }}">Table Fournisseur</a></li>
        </ul>
      </div>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="collapse" href="#icons" aria-expanded="false" aria-controls="icons">
        <i class="mdi mdi-cart"></i>
        <span class="menu-title">Commandes</span>
        <i class="menu-arrow"></i>
      </a>
      <div class="collapse" id="icons">
        <ul class="nav flex-column sub-menu">
          <li class="nav-item"> <a class="nav-link" href="{{ path('app_commande_index') }}">Table</a></li>
        </ul>
      </div>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="collapse" href="#auth" aria-expanded="false" aria-controls="auth">
        <i class="mdi mdi-comment"></i>
        <span class="menu-title">Reclamations</span>
        <i class="menu-arrow"></i>
      </a>
      <div class="collapse" id="auth">
        <ul class="nav flex-column sub-menu">
          <li class="nav-item"> <a class="nav-link" href="{{ path('app_reclamation_liste_admin') }}"> Table </a></li>
          <li class="nav-item"> <a class="nav-link" href="{{ path('app_reclamation_archive') }}"> Archive </a></li>
        </ul>
      </div>
    </li>
   
    
  </ul>
</nav>
        <!-- partial -->
       <div class="main-panel">
          <div class="content-wrapper">
             <div class="title-gestion"> Gestion des Materiaux </div>
            <div class="table-container">
        <div class="table-title">
         
           
            <div class="search-box">
            <i class="fa fa-search"></i>
            <input  id="searchInput" type="text" placeholder="Rechercher...">
            <div id="results"></div>
            <button onclick="sortTableByQuantity()" style="background: none; border: none; padding: 0; cursor: pointer;">
                <i class="fa fa-sort" style="color:rgb(0, 21, 44); font-size: 20px;"></i> 
            </button>
        </div>

       

            

            <a href="{{ path('app_materiaux_new') }}">
            <i class="fa fa-plus"></i>
            </a>
           </div>



        <table id="materiauxTable">
            <thead>
                <tr>
                
                <th>Nom du materiel</th>
                <th>Quantité</th>
                <th>Seuil minimale</th>
                <th>Prix unitaire</th>
                <th>Categorie</th>
                <th>Description</th>
                <th>Photo</th>
                <th>Nom du Fournisseur</th>
                <th>actions</th>
                

                </tr>
            </thead>
            <tbody>
                {% for materiaux in materiauxes %}
                  <tr style="{% if materiaux.quantiteStock <= materiaux.seuilMin %}background-color: #ffcccc; color: #d60000; font-weight: bold;{% endif %}">
                      
                      <td class="nomMateriel">{{ materiaux.nomMateriel }}</td>
                      <td>{{ materiaux.quantiteStock }}</td>
                      <td>{{ materiaux.seuilMin }}</td>
                      <td>{{ materiaux.prixUnitaire }}</td>
                      <td>{{ materiaux.categorie }}</td>
                      <td>
                          <div class="description">
                              <a href="javascript:void(0);" class="show-more-link" onclick="openModal(`{{ materiaux.description|e('js') }}`)">
                                  <i class="fa fa-info-circle" style="color: #17a2b8;"></i> 
                              </a>
                          </div>
                      </td>

                      <td>
                              {{ materiaux.photo }}
                      </td>
                      <td>
                          {% if materiaux.idFournisseur %}
                              {{ materiaux.idFournisseur.nomFournisseur }}
                          {% else %}
                              Aucun fournisseur
                          {% endif %}
                      </td>
                      

                    <td>
                      <a href="{{ path('app_materiaux_edit', {'id': materiaux.id}) }}">
                      <i class="fa fa-edit" style="color: #ffc107;"></i>
                      </a>
                       {{ include('admin/materiaux/_delete_form.html.twig') }}
                      
                    </td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="8">Aucun matériel trouvé</td>
                  </tr>
    
                {% endfor %}

          </tbody>
        </table>
      
{% for message in app.flashes('low_stock') %}
    <div class="flash-message" data-message="{{ message }}"></div>
{% endfor %}

{#  #}


<!--a ajouter -->
<!-- jQuery (nécessaire pour Toastr) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    function showLowStockNotification() {
        document.querySelectorAll('.flash-message').forEach(function(element) {
            let message = element.dataset.message;
            if (message) {
                toastr.warning(message, "Alerte Stock", {
                    closeButton: true,
                    progressBar: true,
                    positionClass: "toast-top-right",
                    timeOut: 5000
                });
            }
            element.remove(); // ✅ Remove the element after showing the alert
        });
    }

    // Show notification when the page loads
    showLowStockNotification();

    // Show notifications every 30 seconds
    setInterval(showLowStockNotification, 30000);
});
</script>


<div class="pagination">
        {# Lien vers la page précédente #}
        <a href="{{ path('app_materiaux_index', {'page': pagination.currentPageNumber > 1 ? pagination.currentPageNumber - 1 : 1}) }}">&laquo;</a>

        {# Liens pour chaque page #}
        {% for i in 1..pagination.pageCount %}
            <a href="{{ path('app_materiaux_index', {'page': i}) }}"
               class="{% if i == pagination.currentPageNumber %}active{% endif %}">
                {{ i }}
            </a>
        {% endfor %}

        {# Lien vers la page suivante #}
        <a href="{{ path('app_materiaux_index', {'page': pagination.currentPageNumber < pagination.pageCount ? pagination.currentPageNumber + 1 : pagination.pageCount}) }}">&raquo;</a>
    </div>



<!-- Modale pour afficher la description complète -->
<div id="descriptionModal" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; margin: 10% auto; padding: 20px; width: 50%; border-radius: 8px; position: relative;">
        <span class="close-btn" onclick="closeModal()" style="position: absolute; top: 10px; right: 15px; font-size: 20px; cursor: pointer;">&times;</span>
        <h4>Description complète</h4>
        <p id="modal-description"></p>
    </div>
</div>
<div class="content-wrapper" style="width: 100%; padding: 20px;">
  <div class="main-panel" style="width: 100%; display: flex; justify-content: center; align-items: center;">
    <div class="materiaux-statistics" style="width: 60%; max-width: 400px; margin-top: 20px; text-align: center;">
        <canvas id="materiauxChart" style="width: 100% !important; height: 350px !important;"></canvas>

        <!-- Légende personnalisée -->
        <div class="legend" style="margin-top: 10px; font-size: 16px; font-weight: bold; text-align: center;">
            <span style="border: 3px solid red; padding: 3px 10px; border-radius: 5px; color: black;">
                🔴 Matériaux avec stock insuffisant
            </span>
        </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById('materiauxChart').getContext('2d');

        // Données des matériaux
        const labels = {{ labels|json_encode()|raw }};
        const data = {{ data|json_encode()|raw }};

        // Fonction pour générer des couleurs modernes et harmonieuses
        function getColor(index) {
            const colors = [
                '#FFADAD', '#FFD6A5', '#FDFFB6', '#CAFFBF', '#9BF6FF',
                '#A0C4FF', '#BDB2FF', '#FFC6FF', '#FF99C8', '#FCF6BD'
            ];
            return colors[index % colors.length];
        }

        // Couleurs d'arrière-plan et bordures conditionnelles
        let backgroundColors = labels.map((_, index) => getColor(index));
        let borderColors = data.map((quantity, index) => quantity < 5 ? 'red' : backgroundColors[index]);

        new Chart(ctx, {
            type: 'pie', 
            data: {
                labels: labels.map(label => (label.length > 12 ? label.substring(0, 12) + '...' : label)),
                datasets: [{
                    label: 'Quantité en Stock',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (tooltipItem) {
                                return `${tooltipItem.label}: ${tooltipItem.raw} unités`;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Répartition des Matériaux en Stock'
                    }
                }
            }
        });
    });
</script>






      </div>
          <!-- content-wrapper ends -->
          <!-- partial:../../partials/_footer.html -->
       
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->
    <!-- plugins:js -->
    {% block js %}
      <script src="{{ asset('build/assets/vendors/js/vendor.bundle.base.js') }}"></script>
      <!-- endinject -->
      <!-- Plugin js for this page -->
      <script src="build/assets/vendors/chart.js/chart.umd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="{{ asset('build/assets/vendors/datatables.net/jquery.dataTables.js') }}"></script>
      <!-- <script src="assets/vendors/datatables.net-bs4/dataTables.bootstrap4.js"></script> -->
      <script src="{{ asset('build/assets/vendors/datatables.net-bs5/dataTables.bootstrap5.js') }}"></script>
      <script src="{{ asset('build/assets/js/dataTables.select.min.js') }}"></script>
      <!-- End plugin js for this page -->
      <!-- inject:js -->
      <script src="{{ asset('build/assets/js/off-canvas.js') }}"></script>
      <script src="{{ asset('build/assets/js/template.js') }}"></script>
      <script src="{{ asset('build/assets/js/settings.js') }}"></script>
      <script src="{{ asset('build/assets/js/todolist.js') }}"></script>
      <!-- endinject -->
      <!-- Custom js for this page-->
      <script src="{{ asset('build/assets/js/jquery.cookie.js') }}" type="text/javascript"></script>
      <script src="{{ asset('build/assets/js/dashboard.js') }}"></script>
      

      
    {% endblock %}
    <!-- <script src="assets/js/Chart.roundedBarCharts.js"></script> -->
    <script src="{{ asset('js/main.js') }}"></script> 
      
    <!-- End custom js for this page-->
 {% endblock %} 

 <script>
 //modale description
function openModal(description) {
    // Insérer la description complète dans la modale
    document.getElementById('modal-description').innerText = description;

    // Afficher la modale
    document.getElementById('descriptionModal').style.display = 'block';
}

function closeModal() {
    // Fermer la modale
    document.getElementById('descriptionModal').style.display = 'none';
}

// Fermer la modale en cliquant en dehors
window.onclick = function(event) {
    let modal = document.getElementById('descriptionModal');
    if (event.target === modal) {
        modal.style.display = "none";
    }
}


// script recherche 
document.getElementById("searchInput").addEventListener("input", function () {
  console.log("searchInput trouvé :", searchInput);
  console.log("Le script de recherche est bien chargé !");

  let query = this.value.trim().toLowerCase();
  console.log("Texte recherché :", query); // Vérifier la saisie utilisateur

  // On effectue la requête fetch ici
  fetch('/materiaux/search?q=' + query)
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur de réseau');
        }
        return response.json(); // Convertit la réponse en JSON
    })
    .then(data => {
        console.log("Données de la recherche:", data);
        let rows = document.querySelectorAll("#materiauxTable tbody tr");
        console.log("Nombre de lignes trouvées :", rows.length); // Vérifier combien de lignes existent

        rows.forEach(row => {
            try {
                let nomMaterielElement = row.querySelector(".nomMateriel");
                
                // Vérifier si la cellule existe
                if (!nomMaterielElement) {
                    console.warn("Aucune cellule '.nomMateriel' trouvée dans cette ligne :", row);
                    return;
                }

                let nomMateriel = nomMaterielElement.textContent.toLowerCase();
                console.log("Comparaison :", nomMateriel, "contient", query, "?", nomMateriel.includes(query));

                if (nomMateriel.includes(query)) {
                    row.style.display = ""; // Afficher la ligne si elle correspond à la recherche
                } else {
                    row.style.display = "none"; // Cacher la ligne si elle ne correspond pas
                }
            } catch (error) {
                console.error("Erreur lors du filtrage d'une ligne :", error);
            }
        });
    })
    .catch(error => {
        console.error("Erreur lors de la requête fetch :", error);
    });
});




// TRI par quantité
let isAscending = true;

function sortTableByQuantity() {
    const table = document.getElementById("materiauxTable");
    const rows = Array.from(table.rows).slice(1); // Exclut l'en-tête

    // Trie les lignes en fonction de la quantité dans la colonne 2 
    const sortedRows = rows.sort((a, b) => {
        const aQuantity = parseFloat(a.cells[1].innerText);
        const bQuantity = parseFloat(b.cells[1].innerText);

        // Si isAscending est true, tri croissant, sinon tri décroissant
        return isAscending ? aQuantity - bQuantity : bQuantity - aQuantity;
    });

    // Remplace les anciennes lignes par les nouvelles lignes triées
    sortedRows.forEach(row => table.appendChild(row));

    // Alterner l'ordre pour le prochain clic
    isAscending = !isAscending;
}




</script>




 </body>
</html>